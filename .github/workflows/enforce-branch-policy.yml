name: ğŸ›¡ï¸ Enforce Branch Rules

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened, edited]
    branches: [main, dev]
  create:

permissions:
  contents: write # needed to delete branches if invalid
  pull-requests: read

concurrency:
  group: branch-policy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # 1- Enforce Branch Naming Convention (on create)
  # ============================================
  enforce-branch-naming:
    if: github.event_name == 'create' && github.ref_type == 'branch'
    name: ğŸ§­ Validate Branch Naming Convention
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§  Check branch naming convention
        run: |
          NEW_BRANCH="${{ github.ref_name }}"
          echo "ğŸ” Checking branch name: $NEW_BRANCH"

          PATTERN='^(feature|chore|bugfix|hotfix)\/[A-Za-z]+-[0-9]+-[a-z0-9-]+$'
          if ! [[ "$NEW_BRANCH" =~ $PATTERN ]]; then
            echo "âŒ Invalid branch name: '$NEW_BRANCH'
                  âœ… Expected format: feature|chore|bugfix|hotfix/JIRAID-something
                  ğŸ’¡ Example: feature/IMS-123-add-login-page"

            git push origin --delete "$NEW_BRANCH"

            echo "ğŸ§¹ Deleted invalid branch '$NEW_BRANCH' from origin."

            exit 1
          fi

          echo "âœ… Branch name follows the required convention."

  # ============================================
  # 2- Enforce Branch Base = dev (on branch create)
  # ============================================
  enforce-base-branch:
    if: github.event_name == 'create' && github.ref_type == 'branch'
    name: ğŸ§­ Enforce Dev as Base Branch
    runs-on: ubuntu-latest
    needs: enforce-branch-naming
    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§  Verify new branch base commit
        run: |
          NEW_BRANCH="${{ github.ref_name }}"
          echo "ğŸ†• New branch detected: $NEW_BRANCH"

          # ğŸ›‘ Prevent accidental deletion of critical branches
          if [[ "$NEW_BRANCH" == "main" || "$NEW_BRANCH" == "dev" ]]; then
            echo "âœ… '$NEW_BRANCH' is a protected branch. Skipping base validation."
            exit 0
          fi

          BASE_COMMIT=$(git rev-parse origin/dev)
          NEW_BRANCH_COMMIT=$(git ls-remote origin "$NEW_BRANCH" | awk '{print $1}')

          echo "ğŸ”¸ Dev base commit: $BASE_COMMIT
                ğŸ”¸ New branch commit: $NEW_BRANCH_COMMIT"

          if [ "$BASE_COMMIT" != "$NEW_BRANCH_COMMIT" ]; then
            echo "âŒ Branch '$NEW_BRANCH' was NOT created from 'dev'.
                  ğŸ’¡ Please recreate the branch from 'dev':"
            echo "git checkout dev && git pull && git checkout -b $NEW_BRANCH"

            git push origin --delete "$NEW_BRANCH"

            echo "ğŸ§¹ Deleted branch '$NEW_BRANCH' from origin."
            exit 1
          else
            echo "âœ… Branch '$NEW_BRANCH' is correctly based on 'dev'."
          fi

  # ============================================
  # 3- Enforce PR Source/Target Policy
  # ============================================
  enforce-branch-policy:
    if: github.event_name == 'pull_request'
    name: ğŸ§­ Enforce PR Source and Target
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§  Validate PR source and target
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          echo "ğŸ” Target branch: $BASE"
          echo "ğŸ” Source branch: $HEAD"

          # Rule 1 â€” Only dev can merge into main
          if [[ "$BASE" == "main" && "$HEAD" != "dev" ]]; then
            echo "âŒ Only PRs from 'dev' are allowed to merge into 'main'."
            exit 1
          fi

          # Rule 2 â€”   Only feature/*, chore/*, bugfix/*, hotfix/* can merge into dev
          if [[ "$BASE" == "dev" ]] && \
            [[ ! "$HEAD" =~ ^feature/ ]] && \
            [[ ! "$HEAD" =~ ^chore/ ]] && \
            [[ ! "$HEAD" =~ ^bugfix/ ]] && \
            [[ ! "$HEAD" =~ ^hotfix/ ]]; then
              echo "âŒ Only 'feature/*', 'chore/*', 'bugfix/*', or 'hotfix/*' branches can merge into 'dev'."
            exit 1
          fi

          echo "âœ… Branch merge allowed: $HEAD â†’ $BASE"

  # ============================================
  # 4- Prevent Direct Commits on Protected Branches
  # ============================================
  prevent-direct-commits:
    if: github.event_name == 'push'
    name: ğŸš« Prevent Direct Commits via GitHub UI
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš« Block direct commits
        run: |
          echo "âŒ Direct commits to protected branches are not allowed.
                âœ… Please open a Pull Request instead."
          exit 1
