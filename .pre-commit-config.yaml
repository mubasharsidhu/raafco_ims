---
# ğŸ‘® Global Pre-commit Configuration
# This file enforces coding standards, security checks, and Git hygiene.
# To install hooks locally:
#   1. pip install pre-commit
#   2. pre-commit install
#   3. pre-commit install --hook-type pre-push  # for push hooks too
#   4. pre-commit autoupdate                    # to update hook versions

repos:
  # ğŸ›¡ï¸ GIT PROTECTION & HYGIENE
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: no-commit-to-branch
        name: ğŸ›¡ï¸ Prevent direct commits to main or dev
        stages: [pre-commit, pre-push]
        args:
          # ğŸ” Explicit branches
          - --branch
          - main
          - --branch
          - dev
          - --branch
          - production

          # ğŸŒ¿ Pattern-based protection (regex)
          - --pattern
          - release/.*
          - --pattern
          - hotfix/.*

      - id: check-merge-conflict # ğŸ§­ Prevent unresolved merge conflicts

      - id: trailing-whitespace # ğŸ§¹ Remove trailing spaces automatically

      - id: end-of-file-fixer # ğŸ“„ Ensure a single newline at EOF

      - id: check-yaml # ğŸ§¾ Validate YAML syntax (e.g., GitHub workflows, config files)

      - id: check-json # ğŸª„ Validate JSON syntax (composer.lock, package.json, etc.)

      - id: check-added-large-files # ğŸš« Block committing large files accidentally
        args: ["--maxkb=1000"]

      - id: detect-private-key # ğŸ”‘ Prevent committing SSH/private keys

      - id: forbid-submodules # ğŸš· Avoid adding Git submodules

      - id: check-case-conflict # ğŸ§± Prevent case conflicts between file names

      - id: check-symlinks # ğŸ”— Detect broken symlinks

  # ğŸ§ª Laravel Tests (via generic command)
  - repo: local
    hooks:
      - id: composer-validate
        name: "ğŸ§¾ Composer Validate"
        entry: bash -c "cd src && composer validate --strict"
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: composer-audit
        name: "ğŸ›¡ï¸ Composer Audit (Security Check)"
        entry: bash -c "cd src && composer audit --no-interaction || (echo 'âŒ Vulnerabilities found!' && exit 1)"
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: pint
        name: "ğŸ¨ Laravel Pint (Code Style)"
        entry: bash -c "cd src && vendor/bin/pint --test --ansi || (echo 'âŒ Vulnerabilities found!' && exit 1)"
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: phpstan
        name: "ğŸ§  PHPStan (Static Analysis)"
        entry: bash -c "cd src && vendor/bin/phpstan analyse --memory-limit=2G --no-progress"
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: laravel-tests
        name: "ğŸ§ª Laravel Tests"
        entry: bash -c "cd src && php artisan test"
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # âœ… Detect secrets before commit
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        stages: [pre-commit]
        args: ["--exclude-files", "src/.env.testing"]
